<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFA Studio - Simulador de Autómatas</title>
    
    <!-- 1. Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Librerías de React (Versión de Desarrollo) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel para traducir JSX a JavaScript que el navegador entienda -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background-color: #0f172a; color: white; margin: 0; overflow: hidden; }
        /* Scrollbars personalizados */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>
    <!-- Aquí es donde React "montará" la aplicación -->
    <div id="root"></div>

    <!-- Tu código de aplicación -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- ICONOS (SVG Inline para no depender de librerías externas) ---
        const Play = ({ size = 24, fill="none" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const Pause = ({ size = 24, fill="none" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>;
        const SkipForward = ({ size = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>;
        const RotateCcw = ({ size = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"></path><path d="M3 3v9h9"></path></svg>;
        const AlertCircle = ({ size = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const CheckCircle = ({ size = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const XCircle = ({ size = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>;
        const MousePointer2 = ({ size = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 12 5.3 5.3"></path><path d="M4 4l3.17 14.26a1 1 0 0 0 1.83.17L12 12l6.57-2.99a1 1 0 0 0 .17-1.84L4 4z"></path></svg>;


        // --- CONFIGURACIÓN Y LÓGICA ---
        const DEFAULT_CONFIG = `{
          "states": ["q0", "q1", "q2", "q3"],
          "alphabet": ["0", "1"],
          "startState": "q0",
          "acceptStates": ["q3"],
          "transitions": {
            "q0": { "0": "q1", "1": "q0" },
            "q1": { "0": "q2", "1": "q0" },
            "q2": { "0": "q3", "1": "q0" },
            "q3": { "0": "q3", "1": "q3" }
          }
        }`;

        const REPULSION = 12000;
        const SPRING_LENGTH = 200;
        const SPRING_STRENGTH = 0.04;
        const DAMPING = 0.90;
        const CENTER_PULL = 0.01;

        const getPointOnCircle = (x, y, radius, angle) => ({
          x: x + radius * Math.cos(angle),
          y: y + radius * Math.sin(angle),
        });

        const calculateEdge = (source, target, isSelfLoop, radius = 30) => {
          if (isSelfLoop) {
            const x = source.x;
            const y = source.y - radius;
            return {
              d: \`M \${x - 10} \${y} C \${x - 40} \${y - 60}, \${x + 40} \${y - 60}, \${x + 10} \${y}\`,
              labelX: x,
              labelY: y - 50
            };
          }

          const dx = target.x - source.x;
          const dy = target.y - source.y;
          const angle = Math.atan2(dy, dx);
          
          const start = getPointOnCircle(source.x, source.y, radius, angle);
          const end = getPointOnCircle(target.x, target.y, radius + 8, angle + Math.PI);

          return {
            d: \`M \${start.x} \${start.y} L \${end.x} \${end.y}\`,
            labelX: (start.x + end.x) / 2,
            labelY: (start.y + end.y) / 2 - 10
          };
        };

        // --- COMPONENTE PRINCIPAL ---
        function DFAEngine() {
          const [code, setCode] = useState(DEFAULT_CONFIG);
          const [parsedDFA, setParsedDFA] = useState(null);
          const [error, setError] = useState(null);
          const [inputString, setInputString] = useState("10100");
          
          const [currentState, setCurrentState] = useState(null);
          const [stepIndex, setStepIndex] = useState(0);
          const [isPlaying, setIsPlaying] = useState(false);
          const [verdict, setVerdict] = useState('pending');
          const timerRef = useRef(null);

          const [nodes, setNodes] = useState([]);
          const requestRef = useRef();
          const draggingNode = useRef(null);
          const svgRef = useRef(null);

          useEffect(() => {
            try {
              const dfa = JSON.parse(code);
              if (!dfa.states || !dfa.startState || !dfa.transitions) {
                throw new Error("Faltan campos requeridos: states, startState, o transitions.");
              }
              setParsedDFA(dfa);
              setError(null);
              resetSimulation(dfa.startState);

              const newNodes = dfa.states.map((s, i) => {
                const angle = (i / dfa.states.length) * 2 * Math.PI;
                const radius = 100;
                return {
                  id: s,
                  x: 300 + radius * Math.cos(angle),
                  y: 200 + radius * Math.sin(angle),
                  vx: 0,
                  vy: 0
                };
              });
              setNodes(newNodes);

            } catch (e) {
              setError(e.message);
            }
          }, [code]);

          const updatePhysics = useCallback(() => {
            setNodes(prevNodes => {
              if (!parsedDFA) return prevNodes;
              
              const nextNodes = prevNodes.map(n => ({ ...n }));
              const width = svgRef.current?.clientWidth || window.innerWidth;
              const height = svgRef.current?.clientHeight || window.innerHeight;

              for (let i = 0; i < nextNodes.length; i++) {
                for (let j = i + 1; j < nextNodes.length; j++) {
                  const n1 = nextNodes[i];
                  const n2 = nextNodes[j];
                  const dx = n1.x - n2.x;
                  const dy = n1.y - n2.y;
                  const distSq = dx * dx + dy * dy || 1;
                  const dist = Math.sqrt(distSq);
                  
                  const force = REPULSION / distSq;
                  const fx = (dx / dist) * force;
                  const fy = (dy / dist) * force;

                  if (draggingNode.current !== n1.id) { n1.vx += fx; n1.vy += fy; }
                  if (draggingNode.current !== n2.id) { n2.vx -= fx; n2.vy -= fy; }
                }
              }

              Object.entries(parsedDFA.transitions).forEach(([srcId, transitions]) => {
                Object.values(transitions).forEach(targetId => {
                   if (srcId === targetId) return;
                   const n1 = nextNodes.find(n => n.id === srcId);
                   const n2 = nextNodes.find(n => n.id === targetId);
                   if (!n1 || !n2) return;

                   const dx = n2.x - n1.x;
                   const dy = n2.y - n1.y;
                   const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                   const force = (dist - SPRING_LENGTH) * SPRING_STRENGTH;

                   const fx = (dx / dist) * force;
                   const fy = (dy / dist) * force;

                   if (draggingNode.current !== n1.id) { n1.vx += fx; n1.vy += fy; }
                   if (draggingNode.current !== n2.id) { n2.vx -= fx; n2.vy -= fy; }
                });
              });

              nextNodes.forEach(n => {
                if (draggingNode.current === n.id) return;
                n.vx += (width / 2 - n.x) * CENTER_PULL;
                n.vy += (height / 2 - n.y) * CENTER_PULL;
                n.x += n.vx;
                n.y += n.vy;
                n.vx *= DAMPING;
                n.vy *= DAMPING;
                if (n.x < 30) { n.x = 30; n.vx *= -1; }
                if (n.x > width - 30) { n.x = width - 30; n.vx *= -1; }
                if (n.y < 30) { n.y = 30; n.vy *= -1; }
                if (n.y > height - 30) { n.y = height - 30; n.vy *= -1; }
              });

              return nextNodes;
            });
            requestRef.current = requestAnimationFrame(updatePhysics);
          }, [parsedDFA]);

          useEffect(() => {
            requestRef.current = requestAnimationFrame(updatePhysics);
            return () => cancelAnimationFrame(requestRef.current);
          }, [updatePhysics]);

          const handleMouseDown = (e, nodeId) => { draggingNode.current = nodeId; e.stopPropagation(); };
          const handleMouseMove = (e) => {
            if (draggingNode.current) {
              const svgRect = svgRef.current.getBoundingClientRect();
              const x = e.clientX - svgRect.left;
              const y = e.clientY - svgRect.top;
              setNodes(prev => prev.map(n => n.id === draggingNode.current ? { ...n, x, y, vx: 0, vy: 0 } : n));
            }
          };
          const handleMouseUp = () => { draggingNode.current = null; };

          const resetSimulation = (startStateOverride = null) => {
            setIsPlaying(false);
            setStepIndex(0);
            setVerdict('pending');
            if (parsedDFA || startStateOverride) {
              setCurrentState(startStateOverride || parsedDFA.startState);
            }
          };

          const step = () => {
            if (!parsedDFA || verdict !== 'pending' || stepIndex > inputString.length) return;
            if (stepIndex === inputString.length) {
                const isAccepted = parsedDFA.acceptStates.includes(currentState);
                setVerdict(isAccepted ? 'accepted' : 'rejected');
                setIsPlaying(false);
                return;
            }
            const char = inputString[stepIndex];
            const transitions = parsedDFA.transitions[currentState];
            if (transitions && transitions[char] !== undefined) {
              setCurrentState(transitions[char]);
              setStepIndex(prev => prev + 1);
            } else {
              setVerdict('rejected');
              setIsPlaying(false);
            }
          };

          useEffect(() => {
            if (isPlaying) { timerRef.current = setInterval(step, 800); } 
            else { clearInterval(timerRef.current); }
            return () => clearInterval(timerRef.current);
          }, [isPlaying, currentState, stepIndex, verdict, parsedDFA]);

          useEffect(() => { resetSimulation(); }, [inputString]);

          const edges = useMemo(() => {
            if (!parsedDFA) return [];
            const edgeMap = {};
            Object.keys(parsedDFA.transitions).forEach(src => {
              Object.entries(parsedDFA.transitions[src]).forEach(([char, tgt]) => {
                const key = `\${src}-\${tgt}`;
                if (!edgeMap[key]) edgeMap[key] = [];
                edgeMap[key].push(char);
              });
            });
            return Object.entries(edgeMap).map(([key, labels]) => {
              const [src, tgt] = key.split('-');
              return { src, tgt, labels: labels.join(','), isSelfLoop: src === tgt };
            });
          }, [parsedDFA]);

          return (
            <div className="flex flex-col h-screen bg-slate-900 text-slate-100 font-sans overflow-hidden" 
                 onMouseUp={handleMouseUp} 
                 onMouseMove={handleMouseMove}>
              
              <header className="flex items-center justify-between px-6 py-4 bg-slate-800 border-b border-slate-700 shadow-md z-10">
                <div className="flex items-center gap-2">
                    <div className="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-bold text-lg shadow-lg shadow-blue-500/20">D</div>
                    <h1 className="text-xl font-bold tracking-tight text-slate-100">DFA Studio <span className="text-xs bg-slate-700 px-2 py-0.5 rounded text-slate-300 font-normal ml-2">Web Standalone</span></h1>
                </div>
              </header>

              <div className="flex flex-1 overflow-hidden">
                
                {/* EDITOR */}
                <div className="w-1/3 min-w-[320px] flex flex-col border-r border-slate-700 bg-slate-950 z-20 shadow-xl">
                  <div className="bg-slate-900 px-4 py-3 text-xs font-mono uppercase text-blue-400 font-bold tracking-widest flex justify-between items-center border-b border-slate-800">
                    <span>Configuración (JSON)</span>
                    {error && <span className="text-red-400 flex items-center gap-1 animate-pulse"><AlertCircle size={12}/> Error</span>}
                  </div>
                  <div className="flex-1 relative group">
                    <textarea
                      className={\`w-full h-full bg-[#0B1120] p-6 font-mono text-sm leading-relaxed resize-none focus:outline-none text-slate-300 selection:bg-blue-500/30 \${error ? 'border-l-4 border-red-500' : ''}\`}
                      value={code}
                      onChange={(e) => setCode(e.target.value)}
                      spellCheck="false"
                    />
                  </div>
                </div>

                {/* VISUALIZATION */}
                <div className="flex-1 flex flex-col bg-slate-900 relative">
                    
                    <div className="h-32 bg-slate-800/80 backdrop-blur-sm border-b border-slate-700 flex flex-col items-center justify-center gap-4 relative z-10 shadow-sm">
                        <div className="flex items-center gap-4">
                            <span className="text-xs uppercase font-bold text-slate-500 tracking-wider">Entrada</span>
                            <input 
                                type="text" 
                                value={inputString}
                                onChange={(e) => setInputString(e.target.value)}
                                className="bg-slate-900 border border-slate-600 rounded px-4 py-1.5 font-mono text-slate-200 focus:outline-none focus:border-blue-500 w-64 text-center tracking-widest shadow-inner"
                            />
                        </div>

                        <div className="flex items-center justify-center gap-1 font-mono text-lg h-10">
                            {inputString.split('').map((char, index) => {
                                const isCurrent = index === stepIndex;
                                return (
                                    <div key={index} className={\`
                                        w-8 h-12 flex items-center justify-center border-b-4 transition-all duration-300 rounded-t
                                        \${isCurrent ? 'border-blue-500 bg-blue-500/10 text-blue-300 -translate-y-1' : 'border-slate-700 text-slate-500'}
                                    \`}>
                                        {char}
                                    </div>
                                )
                            })}
                             <div className={\`w-8 h-12 flex items-center justify-center border-b-4 transition-all duration-300 rounded-t \${stepIndex === inputString.length ? 'border-purple-500 bg-purple-500/10 text-purple-300' : 'border-transparent text-slate-700'}\`}>
                                #
                             </div>
                        </div>

                        <div className="absolute right-8 top-8 transition-all duration-500 transform">
                            {verdict === 'accepted' && (
                                <div className="flex items-center gap-2 text-green-400 bg-green-950/50 px-4 py-2 rounded-lg border border-green-800/50 shadow-lg shadow-green-900/20">
                                    <CheckCircle size={20} /> <span className="font-bold tracking-wide">ACEPTADO</span>
                                </div>
                            )}
                            {verdict === 'rejected' && (
                                <div className="flex items-center gap-2 text-red-400 bg-red-950/50 px-4 py-2 rounded-lg border border-red-800/50 shadow-lg shadow-red-900/20">
                                    <XCircle size={20} /> <span className="font-bold tracking-wide">RECHAZADO</span>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="flex-1 overflow-hidden relative cursor-default" ref={svgRef}>
                        <svg className="w-full h-full pointer-events-none"> 
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="28" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#64748b" />
                                </marker>
                                <marker id="arrowhead-active" markerWidth="10" markerHeight="7" refX="28" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#60a5fa" />
                                </marker>
                            </defs>

                            {nodes.length > 0 && edges.map((edge, i) => {
                                const n1 = nodes.find(n => n.id === edge.src);
                                const n2 = nodes.find(n => n.id === edge.tgt);
                                if (!n1 || !n2) return null;

                                const isActive = currentState === edge.src && isPlaying;
                                const pathData = calculateEdge(n1, n2, edge.isSelfLoop);
                                
                                return (
                                    <g key={i} className="pointer-events-auto">
                                        <path 
                                            d={pathData.d} 
                                            stroke={isActive ? "#60a5fa" : "#334155"} 
                                            strokeWidth="2" 
                                            fill="none" 
                                            markerEnd={isActive ? "url(#arrowhead-active)" : "url(#arrowhead)"}
                                            className="transition-colors duration-200"
                                        />
                                        <rect 
                                            x={pathData.labelX - 12} 
                                            y={pathData.labelY - 10} 
                                            width="24" 
                                            height="20" 
                                            rx="4"
                                            fill="#0f172a" 
                                            className="opacity-90"
                                        />
                                        <text 
                                            x={pathData.labelX} 
                                            y={pathData.labelY} 
                                            fill="#94a3b8" 
                                            fontSize="11" 
                                            textAnchor="middle" 
                                            dominantBaseline="central"
                                            fontWeight="bold"
                                        >
                                            {edge.labels}
                                        </text>
                                    </g>
                                );
                            })}

                            {nodes.map((node) => {
                                const isCurrent = currentState === node.id;
                                const isStart = parsedDFA && parsedDFA.startState === node.id;
                                const isAccept = parsedDFA && parsedDFA.acceptStates.includes(node.id);

                                return (
                                    <g 
                                        key={node.id} 
                                        transform={\`translate(\${node.x},\${node.y})\`}
                                        onMouseDown={(e) => handleMouseDown(e, node.id)}
                                        className="pointer-events-auto cursor-grab active:cursor-grabbing"
                                    >
                                        {isStart && (
                                            <path d="M -50 0 L -35 0" stroke="#64748b" strokeWidth="2" markerEnd="url(#arrowhead)" />
                                        )}
                                        <circle 
                                            r="30" 
                                            fill={isCurrent ? "#1d4ed8" : "#1e293b"} 
                                            stroke={isCurrent ? "#60a5fa" : "#475569"} 
                                            strokeWidth={isCurrent ? "3" : "2"}
                                            className="transition-colors duration-200 shadow-xl"
                                        />
                                        {isAccept && (
                                            <circle r="24" fill="none" stroke={isCurrent ? "#93c5fd" : "#475569"} strokeWidth="2" />
                                        )}
                                        <text 
                                            fill={isCurrent ? "#ffffff" : "#cbd5e1"} 
                                            fontSize="14" 
                                            fontWeight="bold"
                                            textAnchor="middle" 
                                            dominantBaseline="central"
                                            className="pointer-events-none select-none"
                                        >
                                            {node.id}
                                        </text>
                                    </g>
                                );
                            })}
                        </svg>

                        <div className="absolute bottom-4 left-4 text-slate-600 text-xs flex items-center gap-2 pointer-events-none opacity-50">
                            <MousePointer2 size={12} /> Arrastra los nodos para ajustar
                        </div>
                    </div>

                    <div className="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-900/90 backdrop-blur-md border border-slate-700 rounded-2xl px-2 py-2 flex gap-2 shadow-2xl z-30">
                        <button 
                            onClick={() => resetSimulation()}
                            className="p-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-xl transition-colors"
                            title="Reiniciar"
                        >
                            <RotateCcw size={18} />
                        </button>
                        
                        <div className="w-px bg-slate-700 my-2 mx-1"></div>

                        {!isPlaying ? (
                            <button 
                                onClick={() => {
                                     if(verdict !== 'pending') resetSimulation();
                                     setIsPlaying(true);
                                }}
                                disabled={verdict !== 'pending' && stepIndex === inputString.length}
                                className="p-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl shadow-lg shadow-blue-900/40 transition-all hover:scale-105 active:scale-95 disabled:opacity-50 disabled:grayscale"
                            >
                                <Play fill="currentColor" size={20} />
                            </button>
                        ) : (
                            <button 
                                onClick={() => setIsPlaying(false)}
                                className="p-3 bg-amber-500 hover:bg-amber-400 text-white rounded-xl shadow-lg shadow-amber-900/40 transition-all hover:scale-105 active:scale-95"
                            >
                                <Pause fill="currentColor" size={20} />
                            </button>
                        )}

                        <button 
                            onClick={step}
                            disabled={isPlaying || verdict !== 'pending'}
                            className="p-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-xl transition-colors disabled:opacity-30"
                            title="Paso a paso"
                        >
                            <SkipForward size={18} />
                        </button>
                    </div>
                    
                </div>
              </div>
            </div>
          );
        }

        // --- MONTAJE DE LA APP ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DFAEngine />);
    </script>
</body>
</html>
